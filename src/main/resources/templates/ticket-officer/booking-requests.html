<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Booking Requests - Ticket Officer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: url('/images/1200x500.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            padding-top: 100px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .card-header {
            background: linear-gradient(135deg, #007116 0%, #003a0d 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #007116 0%, #003a0d 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
        }
        .btn-secondary {
            border-radius: 25px;
            padding: 0.75rem 2rem;
        }
        .booking-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .booking-card:hover {
            border-color: #007116;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
        }
        .status-pending {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
        }
        .status-confirmed {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }
        .status-ticket-generated {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        .status-canceled {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        .class-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
        }
        .class-a {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        .class-b {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
        }
        .class-c {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }
        .pricing-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .seat-display {
            display: inline-block;
            background: #007116;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 15px;
            margin: 0.2rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card">
                    <div class="card-header text-center">
                        <h2><i class="fas fa-ticket-alt me-2"></i>Booking Requests</h2>
                        <p class="mb-0">Review pending bookings and generate tickets</p>
                        <small>Welcome, <span th:text="${currentUser.fullName}">Ticket Officer</span></small>
                    </div>
                    <div class="card-body p-4">
                        
                        <!-- Success/Error Messages -->
                        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <span th:text="${successMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- Navigation -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <a href="/ticket-officer/dashboard" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                                </a>
                            </div>
                            <div class="col-md-6 text-end">
                                <a href="/ticket-officer/bookings" class="btn btn-primary">
                                    <i class="fas fa-list-alt me-2"></i>View All Bookings
                                </a>
                            </div>
                        </div>

                        <!-- Booking Requests List -->
                        <div th:if="${pendingBookings.isEmpty()}" class="text-center py-5">
                            <i class="fas fa-ticket-alt fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">No Pending Booking Requests</h4>
                            <p class="text-muted">All bookings have been processed. Check back later for new requests.</p>
                        </div>

                        <div th:each="booking : ${pendingBookings}" class="booking-card">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h5 class="mb-2">
                                                <i class="fas fa-user me-2"></i>
                                                <span th:text="${booking.passengerName}">John Doe</span>
                                            </h5>
                                            <p class="mb-1">
                                                <i class="fas fa-train me-2"></i>
                                                <strong th:text="${booking.schedule != null and booking.schedule.train != null ? booking.schedule.train.name : 'N/A'}">Blue Line Express</strong>
                                            </p>
                                            <p class="mb-1">
                                                <i class="fas fa-route me-2"></i>
                                                <span th:text="${booking.schedule != null ? booking.schedule.fromStation + ' → ' + booking.schedule.toStation : 'N/A'}">Colombo → Kandy</span>
                                            </p>
                                            <p class="mb-1">
                                                <i class="fas fa-calendar me-2"></i>
                                                <span th:text="${booking.schedule != null ? #temporals.format(booking.schedule.date, 'dd/MM/yyyy') : 'N/A'}">25/12/2024</span>
                                            </p>
                                            <p class="mb-1">
                                                <i class="fas fa-clock me-2"></i>
                                                <span th:text="${booking.schedule != null ? booking.schedule.departureTime + ' - ' + booking.schedule.arrivalTime : 'N/A'}">08:00 - 11:30</span>
                                            </p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-1">
                                                <i class="fas fa-chair me-2"></i>
                                                <strong>Seats:</strong>
                                                <span th:if="${booking.seats != null and !booking.seats.isEmpty()}"
                                                      th:each="seat : ${booking.seats}" 
                                                      th:text="${seat.seatNumber}" 
                                                      class="seat-display">A1-W1</span>
                                                <span th:if="${booking.seats == null or booking.seats.isEmpty()}"
                                                      class="text-muted">No seats assigned</span>
                                            </p>
                                            <p class="mb-1">
                                                <i class="fas fa-tag me-2"></i>
                                                <strong>Class:</strong>
                                                <span th:if="${bookingPricing != null and bookingPricing[booking.id] != null}"
                                                      th:text="${bookingPricing[booking.id].classType}"
                                                      th:class="'class-badge class-' + ${#strings.toLowerCase(bookingPricing[booking.id].classType.substring(0,1))}">First Class</span>
                                                <span th:if="${bookingPricing == null or bookingPricing[booking.id] == null}"
                                                      class="class-badge class-a">Pending</span>
                                            </p>
                                            <p class="mb-1">
                                                <i class="fas fa-dollar-sign me-2"></i>
                                                <strong>Total Price:</strong>
                                                <span th:if="${bookingPricing != null and bookingPricing[booking.id] != null}"
                                                      th:text="'Rs. ' + ${bookingPricing[booking.id].totalAmount}"
                                                      class="text-success fw-bold">Rs. 2000.00</span>
                                                <span th:if="${bookingPricing == null or bookingPricing[booking.id] == null}"
                                                      class="text-muted">To be calculated</span>
                                            </p>
                                            <p class="mb-1">
                                                <i class="fas fa-calendar-plus me-2"></i>
                                                <strong>Booked On:</strong>
                                                <span th:text="${booking.bookingTime != null ? #temporals.format(booking.bookingTime, 'dd/MM/yyyy HH:mm') : 'N/A'}">25/12/2024 10:30</span>
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <!-- Pricing Details -->
                                    <div th:if="${bookingPricing != null and bookingPricing[booking.id] != null}" class="pricing-info">
                                        <h6 class="mb-2"><i class="fas fa-receipt me-2"></i>Ticket Pricing Details</h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <small class="text-muted">Price per Seat:</small><br>
                                                <strong th:text="'Rs. ' + ${bookingPricing[booking.id].pricePerSeat}">Rs. 2000.00</strong>
                                            </div>
                                            <div class="col-md-3">
                                                <small class="text-muted">Number of Seats:</small><br>
                                                <strong th:text="${bookingPricing[booking.id].seatCount}">1</strong>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">Total Amount:</small><br>
                                                <strong class="text-success" th:text="'Rs. ' + ${bookingPricing[booking.id].totalAmount}">Rs. 2000.00</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4 text-end">
                                    <div class="mb-3">
                                        <span th:if="${booking.status == 'CANCELED' or booking.status == 'CANCELLED'}" class="status-badge status-canceled">
                                            <i class="fas fa-ban me-1"></i>
                                            <span th:text="${booking.status}">CANCELED</span>
                                        </span>
                                        <span th:if="${booking.status == 'CONFIRMED'}" class="status-badge status-confirmed">
                                            <i class="fas fa-check-circle me-1"></i>
                                            <span th:text="${booking.status}">CONFIRMED</span>
                                        </span>
                                        <span th:if="${booking.status == 'TICKET_GENERATED'}" class="status-badge status-ticket-generated">
                                            <i class="fas fa-ticket-alt me-1"></i>
                                            <span>TICKET READY</span>
                                        </span>
                                        <span th:if="${booking.status != 'CANCELED' and booking.status != 'CANCELLED' and booking.status != 'CONFIRMED' and booking.status != 'TICKET_GENERATED'}" class="status-badge status-pending">
                                            <i class="fas fa-clock me-1"></i>
                                            <span th:text="${booking.status}">PENDING</span>
                                        </span>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <!-- Only show confirm button if booking is not canceled and ticket not already generated -->
                                        <form th:if="${booking.status != 'CANCELED' and booking.status != 'CANCELLED' and booking.status != 'TICKET_GENERATED'}" 
                                              th:action="@{/ticket-officer/booking-requests/{id}/confirm(id=${booking.id})}" method="post">
                                            <button type="submit" class="btn btn-success w-100" 
                                                    onclick="return confirm('Are you sure you want to confirm this booking and generate the ticket?')">
                                                <i class="fas fa-check-circle me-2"></i>Confirm & Generate Ticket
                                            </button>
                                        </form>
                                        
                                        <!-- Show ticket generated message if ticket already generated -->
                                        <div th:if="${booking.status == 'TICKET_GENERATED'}" class="alert alert-info text-center">
                                            <i class="fas fa-ticket-alt me-2"></i>Ticket Generated
                                        </div>
                                        
                                        <!-- Show canceled message if booking is canceled -->
                                        <div th:if="${booking.status == 'CANCELED' or booking.status == 'CANCELLED'}" class="alert alert-danger text-center">
                                            <i class="fas fa-ban me-2"></i>Booking Canceled
                                        </div>
                                        
                                        <a th:href="@{/ticket-officer/bookings/{id}(id=${booking.id})}" class="btn btn-outline-primary w-100">
                                            <i class="fas fa-eye me-2"></i>View Details
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Summary -->
                        <div th:if="${!pendingBookings.isEmpty()}" class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Summary:</strong> 
                                    <span th:text="${pendingBookings.size()}">0</span> pending booking request(s) waiting for ticket generation.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
